---
name: 添加用户认证系统
overview: 在现有 FastAPI 应用基础上添加基于 Session 的用户认证系统，包括用户模型、登录/登出功能、路由保护，以及登录页面。
todos:
  - id: update-dependencies
    content: 更新 requirements.txt，添加 passlib[bcrypt] 依赖
    status: completed
  - id: add-user-model
    content: 在 app/models.py 中添加 User 数据模型
    status: completed
  - id: add-auth-schemas
    content: 在 app/schemas.py 中添加认证相关的 Pydantic Schema
    status: completed
  - id: create-auth-module
    content: 创建 app/auth.py，实现密码哈希、验证和用户认证函数
    status: completed
    dependencies:
      - update-dependencies
  - id: add-session-middleware
    content: 在 app/main.py 中添加 SessionMiddleware 配置
    status: completed
    dependencies:
      - create-auth-module
  - id: add-login-routes
    content: 在 app/main.py 中添加登录、登出和获取当前用户的路由
    status: completed
    dependencies:
      - add-session-middleware
      - add-auth-schemas
  - id: create-login-page
    content: 创建 templates/login.html 登录页面模板
    status: completed
  - id: protect-routes
    content: 为所有需要认证的路由添加 get_current_user 依赖
    status: completed
    dependencies:
      - add-login-routes
  - id: add-login-redirect
    content: 实现未认证用户重定向到登录页面的逻辑
    status: completed
    dependencies:
      - protect-routes
      - create-login-page
  - id: update-frontend
    content: 更新前端页面，添加用户信息显示和登出功能
    status: completed
    dependencies:
      - add-login-routes
---

# 添加用户认证系统

## 概述

为运维工具箱添加基于 Session 的用户认证系统。用户需要输入账号和密码才能访问应用。采用管理员手动创建用户的方式，密码使用 bcrypt 加密存储。

## 实现步骤

### 1. 更新依赖项

在 `requirements.txt` 中添加密码哈希库：

- `passlib[bcrypt]==1.7.4` - 密码哈希和验证
- `python-jose[cryptography]==3.3.0` - JWT 支持（可选，用于未来扩展）

### 2. 创建用户数据模型

在 `app/models.py` 中添加 `User` 模型：

- `id`: 主键
- `username`: 用户名（唯一）
- `hashed_password`: 加密后的密码
- `is_active`: 是否激活
- `create_time`: 创建时间

### 3. 创建认证相关的 Schema

在 `app/schemas.py` 中添加：

- `UserLogin`: 登录请求（username, password）
- `UserOut`: 用户信息输出（不包含密码）
- `UserCreate`: 创建用户（用于管理员创建用户）

### 4. 创建认证工具模块

新建 `app/auth.py` 文件，包含：

- `verify_password()`: 验证密码
- `get_password_hash()`: 生成密码哈希
- `authenticate_user()`: 验证用户凭证
- `get_current_user()`: 从 Session 获取当前用户（依赖注入）
- `login_required()`: 认证依赖装饰器

### 5. 添加 Session 中间件

在 `app/main.py` 中：

- 导入 `SessionMiddleware` 和 `SecretKey`
- 配置 Session 中间件（需要设置 SECRET_KEY）

### 6. 创建登录/登出路由

在 `app/main.py` 中添加：

- `POST /api/login`: 登录接口，验证用户名密码，创建 Session
- `POST /api/logout`: 登出接口，清除 Session
- `GET /api/me`: 获取当前登录用户信息

### 7. 创建登录页面

新建 `templates/login.html`：

- 登录表单（用户名、密码）
- 错误提示显示
- 登录成功后重定向到首页

### 8. 保护现有路由

在 `app/main.py` 中为所有需要认证的路由添加 `Depends(get_current_user)`：

- 所有 HTML 页面路由（`/`, `/manage/scripts`, `/scripts/{script_id}`）
- 所有 API 路由（`/api/*`）

### 9. 添加登录重定向逻辑

- 未认证用户访问受保护路由时，重定向到 `/login`
- 登录成功后重定向到原始请求的页面或首页

### 10. 更新前端页面

在 `templates/index.html` 和 `templates/manage_scripts.html` 中：

- 添加用户信息显示（当前登录用户）
- 添加登出按钮/链接

### 11. 创建初始管理员用户脚本

创建 `scripts/create_admin.py` 或提供说明文档，用于创建第一个管理员用户。

## 文件修改清单

### 需要修改的文件：

- `requirements.txt` - 添加认证相关依赖
- `app/models.py` - 添加 User 模型
- `app/schemas.py` - 添加认证相关 Schema
- `app/main.py` - 添加 Session 中间件、登录/登出路由、路由保护
- `templates/index.html` - 添加用户信息和登出功能
- `templates/manage_scripts.html` - 添加用户信息和登出功能

### 需要新建的文件：

- `app/auth.py` - 认证工具函数
- `templates/login.html` - 登录页面

## 技术细节

### Session 配置

- 使用 FastAPI 的 `SessionMiddleware`
- Session 存储在 Cookie 中（httpOnly=True，secure=False 用于开发）
- 需要设置 `SECRET_KEY` 环境变量或配置文件

### 密码安全

- 使用 `passlib` 的 `bcrypt` 进行密码哈希
- 密码不存储明文，只存储哈希值

### 路由保护策略

- 所有页面和 API 都需要认证
- 登录页面和静态资源不需要认证
- 使用依赖注入 `Depends(get_current_user)` 统一处理认证

## 数据库迁移

由于添加了新的 `User` 表，需要：

1. 运行 `Base.metadata.create_all(bind=engine)` 创建表（已在 main.py 中）
2. 或使用 Alembic 创建迁移脚本（推荐生产环境）

## 后续优化建议

1. 添加用户角色和权限管理（管理员/普通用户）
2. 添加密码修改功能
3. 添加登录日志记录
4. 添加账户锁定机制（多次登录失败）
5. 支持记住我功能（延长 Session 有效期）